---
title:    SDR enhancement by clouds

subtitle: A Short Subtitle

author:
  - Athanasios N. Natsis^[Laboratory of Atmospheric Physics _natsisphysicist@gmail.com_] 
  - Alkiviadis Bais^[Laboratory of Atmospheric Physics _abais@auth.gr_] 
  - Charikleia Meleti^[Laboratory of Atmospheric Physics _meleti@auth.gr_]

# abstract: |
#   This is the abstract. Lorem ipsum dolor sit amet, eu efficitur justo rutrum at. Sed at tempus elit.

keywords: 
  - keyword1
  - keyword2

bibliography:  [bibliography.bib]

date: "`r format(Sys.time(), '%F')`"

header-includes:
  - \usepackage{caption}
  - \usepackage{placeins}
  - \captionsetup{font=small}

output: 
  # redoc::redoc: default
 #  rticles::mdpi_article:
 #    extra_dependencies:  longtable
 #    keep_tex:            yes
  bookdown::pdf_document2:
    number_sections:  yes
    fig_caption:      yes
    keep_tex:         yes
    latex_engine:     xelatex
    toc:              yes
    toc_depth:        4
    fig_width:        7
    fig_height:       4.5
    documentclass:    article
    classoption:      a4paper,oneside
    fontsize:         12pt
    geometry:         "left=0.75in,right=0.75in,top=0.75in,bottom=0.75in"
    link-citations:   yes
    colorlinks:       yes
    urlcolor:         blue
    biblio-style:     apalike
    bookdown::word_document2: default
---

```{r setup, echo=F, include=FALSE}
rmarkdown::find_pandoc(dir = '/usr/lib/rstudio/resources/app/bin/quarto/bin/tools')
renv::load("~/MANUSCRIPTS/02_enhancement/", quiet = TRUE)
## document configurations
knitr::opts_chunk$set(comment    = ""      )
# knitr::opts_chunk$set(dev        = "pdf"   )
knitr::opts_chunk$set(out.width  = "60%"   )
knitr::opts_chunk$set(fig.align  = "center")
knitr::opts_chunk$set(fig.pos    = 'h!'    )
options(knitr.graphics.auto_pdf = FALSE)
library(pander)
library(data.table)
library(kableExtra)
library(dplyr)
## load data from trends analysis
source("~/MANUSCRIPTS/02_enhancement/GHI_enh_00_variables.R")
load("~/MANUSCRIPTS/02_enhancement/data/GHI_enh_03_process.Rda")
TSIinfo <- data.table(read.csv("~/MANUSCRIPTS/02_enhancement/figures/tbl_tsi_info.dat",
                               strip.white = TRUE,
                               sep = ";",
                               header = TRUE))
```

# Abstract {.unnumbered}

- Phenomenon
- Effects
- bibliography
- our approach
- our results







CE: cloud enhancement cases one minute

ECE: extreme cloud enhancement cases one minute over TSI on horizontal plane

CEG: cloud enhancement groups, cases events with consecutive CE

$\text{GHI}_\text{i}$: measured one minute global horizontal irradiance 

$\text{GHI}_\text{mCSi}$: modeled clear sky one minute global horizontal irradiance 



# Intro


CE and ECE usefulness 
importance
problems

reported trends

CE mechanism

<!-- Define CE and ECE -->
In this study, we define as cloud enhancement events (CE) the cases when the measured
global horizontal irradiance (GHI) at ground level, exceeds the expected value under
clear-sky conditions.
Similar, we define the extreme cloud enhancement events (ECE), the cases when GHI,
exceeds the Total Solar Irradiance on horizontal plane at ground level.
Although the duration of these bursts varies from instantaneous to several minutes,
here we are constrained by the recorded data, to one-minute steps. 



Identify CE cases 

Characteristics of CE

Climatology and impact on the GHI


Effects of clouds

- enhancement physics
- conditions
- other interferences

Identification methods from bib

- clearness index
- modeled approaches
- algorithmic id
- AI
- Visual


Constrains of the site

- data
- instrument
- location





# Data and methodology

## GHI data

Our monitoring site is operating in the Laboratory of Atmospheric Physics of the
Aristotle University of Thessaloniki (\(40^\circ\,38'\,\)N,
\(22^\circ\,57'\,\)E, \(80\,\)m\ a.s.l.).
In this study we present data from the period
`r strftime(min(ST_daily$Date), "%d\\ %B %Y")` to
`r strftime(max(ST_daily$Date), "%d\\ %B %Y")`.

<!-- Instrument -->
The GHI data were measured with a Kipp\ & Zonen CM-21 pyranometer.
During the study period, the pyranometer was independently calibrated three times at
the Meteorologisches Observatorium Lindenberg, DWD, verifying that the stability of
the instrument’s sensitivity was better than $0.7\%$ relative to the initial
calibration by the manufacturer.

<!-- Measurements -->
For the acquisition of radiometric data, the signal of the pyranometer was sampled
at a rate of $1\,\text{Hz}$.
The mean and the standard deviation of these samples were calculated and recorded
every minute.
The measurements were corrected for the zero offset ("dark signal" in volts), which
was calculated by averaging all measurements recorded for a period of $3\,\text{h}$,
before (morning) or after (evening) the Sun reaches an elevation angle of $-10^\circ$.
The signal was converted to irradiance using a ramped value of the instrument’s
sensitivity between subsequent calibrations.

<!-- Radiation data quality check -->
To further improve the quality of the irradiance data, a manual screening was
performed to remove inconsistent and erroneous recordings that can occur
stochastically or systematically during the continuous operation of the instruments.
The manual screening was aided by a radiation data quality assurance procedure,
adjusted for the site, which was based on the methods of Long and Shi\ [@Long2006; @Long2008a].
Thus, problematic recordings have been excluded from further processing.
Although it is impossible to detect all false data, the large number of available
data, and the aggregation scheme we used, ensures the quality of the radiation
measurements used in this study.

<!-- Data selection -->
To preserve an unbiased representation of the data we applied a constraint similar
the one used by @CastillejoCuberos2020. Where, for each valid hour of day, there
must exist at list 45 minutes of valid measurements, including nighttime near
sunrise and sunset. Days with less than 5 valid hours are rejected completely.
<!--# CastillejoCuberos2020 There must be at least 5 h of valid data (Tests 1–7),
otherwise all data for this day is flagged as invalid. There must be at least This
work valid data 45 min of valid data (Tests 1–7) for an hour to be flagged as valid,
otherwise all minute data for this hour is flagged as invalid. -->
Furthermore, due to the significant measurement uncertainty when the Sun is near the
horizon, and to some systematic obstructions by nearby buildings, we have excluded
all measurements with solar zenith angle (SZA) greater than $`r 90-BIO_ELEVA`^\circ$.



In this study, we evaluated the effects of the clouds on th


- available data
  - sky cam
  - chp1
  - cm21
  - cimel
- CSid tool


The recording of the signal is the one-minute average.
Thus, we will refer to this timescale as a cloud enhancement event (CE).








## Clear Sky Irradiance

In order to identify CE cases, we need an approximation of the expected clear sky GHI
for the whole period of the study, with a temporal resolution of one minute.  Because
of the lack of exact data about atmospheric factors, responsible for the attenuation
of the solar radiation in the atmosphere, we can not recreate a minute by minute
representation of the reference radiation. Thus, we used some climatological data
with a radiation transfer model.

We decided to use the Libradtran [@Emde2016] radiation transfer model, to model
the clear sky equivalent of GHI, with monthly climatological data of AOD and water
column from the Aerosol Robotic Network (AERONET) [@Giles2019; @Buis1998].  Our site
participates in AERONET, where we operate a Cimel photometer, collocated to
the CM-21 pyranometer, since 2003

For the production of .....

We also used the Sun's total solar irradiance from NOAA [@Coddington2005] and the
Earth - Sun distance calculated by Astropy [@AstropyCollaboration2022].  We simulated
the clear sky radiation, using the solar radiation spectrum of @Kurucz1994 in the
range $280$ to $2500\,\text{nm}$, with a SZA step of $0.2^\circ$.  For the
atmospheric characteristics, we used combinations of AOD at $500\,\text{nm}$
($t_{500\text{nm}}$) and additional offsets of $\pm1$ and $\pm2\sigma$, water column
($w_h$) with offsets of $\pm1$ and $\pm2\sigma$, and applied it to two atmospheric
profiles "AFGL atmospheric constituent profile, midlatitude summer" (afglms) and
"AFGL atmospheric constituent profile, midlatitude winter" (afglmw) [@Anderson1986].
Thus, we were able to emulate different atmospheric condition and level of
atmospheric clearness for the climatological conditions of the site.

Furthermore, to account for the Sun's variability in our one-minute GHI measurements,
we adjusted the model's input spectrum integral to the one of the TSI provided by
NOAA.  Finally, we adjusted for the effect of the Sun - Earth distance, and
calculated the clear sky irradiance value at the horizontal plane by using the cosine
of the corresponding interpolated SZA.  For each period of the year, we used the
appropriate atmospheric profile (afglms or afglmw).  Thus, the modeled GHI_modeled we
can directly compare each measured one minute value of GHI, with the expected clear
sky radiation.

- rte_solver  disort
- geometry   pseudospherical
- mol_abs LOWTRAN

Of course, have to choose which atmospheric conditions qualify as a good clear sky analogous radiation.


After some evaluation of the modeled radiation in different atmospheric conditions,
in relation to the GHI data, we choose as representative of the clear sky radiation,
the case with
$t_{\text{cs}} = t_{500\text{nm}} - 1\sigma$ and $w_{h\text{cs}} = w_h - 1\sigma$.

Which is an expected result as these values represent a typical atmosphere in
Thessaloniki with low load of aerosols and humidity, which are the main factor that
attenuate the GHI, excluding clouds.



## Thresholds investigation

The use of the actual modeled values of clear sky GHI can not provide us with a
robust method to distinguish the CE cases, due to the limited accuracy of the input
data. Our main focus was to positively identify over irradiance events from CEs,
thus we used a relative factor, to create an upper envelope of the clear sky
irradiance, above which, any GHI value can safely attributed to CE.

To select the exact values of the thresholds (Equation \ref{eq:CE4}), we implemented
manual inspection of the CE identification, on specially selected days from the whole
dataset.  We used seven sets of selected days, with characteristics relevant to the
efficiency of the identification threshold.  These sets were random groups of about
20 to 30 days with the following characteristics:
(a) the largest over irradiance CE events,
(b) the largest daily total over irradiance,
(c) without clouds (by implementing a clear sky identification algorithm as discussed in @Natsis2023),
(d) without clouds and without EC events,
(e) with at least $60\%$ of the day length without clouds and some EC events,
(h) random days and
(i) some manual selected days that were included during the manual inspection.

<!-- - some manual selected days that were included during the manual inspection -->
<!-- - 20 days with the largest over irradiance CE events -->
<!-- - 30 days with largest total over irradiance -->
<!-- - 20 days without clouds (CSid) @Natsis2023 -->
<!-- - any day without clouds and EC events -->
<!-- - 20 days with at least 60% of day length without clouds and some EC events -->
<!-- - 30 random days -->
<!-- - some manual selected days that were included during the manual inspection -->

Where it was needed, for some of the edge cases, we also used images from a sky-cam,
along with the manual inspection.


Reasoning for the  final selection...........



## Criteria for enhancement identification




Many have used models or some statistical method to determine then CE thresholds.

....... cite ...... Descriptions

We used as reference a modeled clear sky approximation,

Criteria for cloud enhancement identification are set according the Equation \ref{eq:CE4}

\begin{equation}
\text{CE}_\text{Threshold} = \begin{cases}
`r C4_cs_ref_ratio`, & \text{$\theta \leq `r C4_lowcut_sza`^\circ$}\\
\frac{`r C4_cs_ref_ratio` - `r C4_lowcut_ratio`}{`r C4_lowcut_sza` - `r 90 - BIO_ELEVA`} \cdot (\theta- `r 90 - BIO_ELEVA`) + `r C4_lowcut_ratio` , & \text{$ `r 90 - BIO_ELEVA`^\circ > \theta > `r C4_lowcut_sza`^\circ$}\\
\text{Excluded measurements}, & \theta > `r 90 - BIO_ELEVA`^\circ
\end{cases}\label{eq:CE4}
\end{equation}
where: $\theta$ solar zenith angle.





A secondary criterion was used for extreme cloud enhancement cases (ECE) identification, relative to the TSI at horizontal plane (Equation \ref{eq:ECE})

\begin{equation}
\text{GHI} > \cos(\theta) \times \text{TSI}_\text{TOA}
\label{eq:ECE}
\end{equation}



Include Example of days plot? Appendix?

... this is more clear to understand and describe ....




## Other method used and rejected

-   some other criteria were tested




<!-- ```{r echo=F, include=T, warning=FALSE, message=FALSE} -->
<!-- ST_total -->
<!-- cat("\n - - - \n") -->
<!-- ST_daily[which.max(wattGLB.max), wattGLB.max] -->
<!-- round(ST_E_daily[which.max(GLB_diff.max), GLB_diff.max], 2) -->
<!-- round(100*ST_daily[which.max(GLB_ench.max), GLB_ench.max],1) -->
<!-- plot(ST_daily$Date, ST_daily$GLB_diff.max) -->
<!-- ``` -->



\FloatBarrier

# Results


Our dataset, after the data selection processing, consists of
`r ST_total$wattGLB.N` records of GHI, of which
$`r round(100*ST_total$GLB_diff.N_pos/ST_total$wattGLB.N, 3)`\,\%$ are CE and
$`r round(100*ST_extreme_total$GLB_diff.N_pos/ST_total$wattGLB.N, 3)`\,\%$ are ECE events.
The highest GHI recorder was 
$`r round(ST_daily[which.max(wattGLB.max), wattGLB.max],1)`\,W/m^2$
on `r strftime(ST_daily[which.max(wattGLB.max), Date], "%d\\ %B %Y")`.
The absolute stronger CE event had an over irradiance of 
$`r round(ST_daily[which.max(GLB_diff.max), GLB_diff.max], 2)`\,W/m^2$ on
`r strftime(ST_daily[which.max(GLB_diff.max), Date], "%d\\ %B %Y")`.
The relative stronger CE event was 
$`r round(100*ST_daily[which.max(GLB_ench.max), GLB_ench.max],1)`\,\%$ above the 
clear sky threshold, on 
`r strftime(ST_daily[which.max(GLB_ench.max), Date], "%d\\ %B %Y")`.


## Trends

```{r loadtrends, echo=F, include=T, warning=FALSE, message=FALSE}
dailytrends <- data.table(
  read.csv("~/MANUSCRIPTS/02_enhancement/figures/Daily_trends_byYear.csv"))
dailyCE <- dailytrends[DATA == "ST_E_daily"]
yearlytrends <- data.table(
  read.csv("~/MANUSCRIPTS/02_enhancement/figures/Daily_trends_byYear_Proper.csv"))
yearlyCE <- yearlytrends[DATA == "ST_E_yearly"]

```

We computed the daily trend of the mean over irradiance of CE
(Figure\nobreakspace{}\ref{fig:CEmeanDaily}), using a first-order autoregressive
model with lag of 1 day, using the 'maximum likelihood' fitting method [@Gardner1980;
@Jones1980] by implementing the function 'arima' from the library 'stats' of the R
programming language [@RCT2023]. The trends were reported together with the $2\sigma$
error.  We observe an increase of
$`r round(dailyCE[var == "GLB_diff.mean", Tmod_Estimate], 3)`\pm
`r round(2 * dailyCE[var == "GLB_diff.mean", Tmod_Std..Error], 3)`\,W/m^2$
on the mean over irradiance.

```{r CEmeanDaily, echo=FALSE, fig.cap="Daily mean values and trend of the CE over irradiance."}
knitr::include_graphics("../images/P_daily_trend-1.png")
```

Although, the previous result is closer to the raw data, we preferred to present the
annual statistics, that give a more clear picture about the long term CE trends.
Hence, we calculated the annual values from the one-minute measurements.
The annual mean over irradiance is
$`r round(yearlyCE[var == "GLB_diff.mean", slope], 2)`\pm
`r round(2 * yearlyCE[var == "GLB_diff.mean", slope.sd], 2)`\,W/m^2$
(Figure\nobreakspace{}\ref{fig:P-energy-mean}),
but this value is not very useful due the high
variability of this metric.

<!-- ```{r CEmeanDaily2, echo=FALSE, fig.cap="Trend of the daily excess energy due to CE"} -->
<!-- knitr::include_graphics("../images/daily-12.png") -->
<!-- ``` -->

<!-- ```{r echo=FALSE, fig.cap="Treds of the mean over irradiance per CE"} -->
<!-- knitr::include_graphics("../images/energy-3.png") -->
<!-- ``` -->

```{r P-energy-mean, echo=FALSE, fig.cap="Trends of the mean over irradiance per CE."}
knitr::include_graphics("../images/P_energy-7.png")
```

A better indicator of changes on the characteristic of CE would be the number of CE
occurrences and the total energy of the CE over irradiance. The annual number of CE
occurrences, shows a steady increase of
$`r round(yearlyCE[var == "GLB_diff.N", slope], 1)`\pm
`r round(2 * yearlyCE[var == "GLB_diff.N", slope.sd], 1)`\,/y$
(Figure\nobreakspace{}\ref{fig:P-energy-N}).
We have to note that the energy related to the CE events can not be directly linked
with the total energy balance on the atmosphere. The net sun radiation of the region
is not increased, but rather redistributed through the CE.

<!-- ```{r echo=FALSE, fig.cap="Trend of number of CE cases"} -->
<!-- knitr::include_graphics("../images/energy-2.png") -->
<!-- ``` -->

```{r P-energy-N, echo=FALSE, fig.cap="Trend of yearly CE number of occurancies."}
knitr::include_graphics("../images/P_energy-6.png")
```
Subsequently, the annual energy observed during CE events shows a annual increase of
$`r round(yearlyCE[var == "GLB_diff.sum", slope], 1)`\pm
`r round(2 * yearlyCE[var == "GLB_diff.sum", slope.sd], 1)`\,kJ/y$
(Figure\ \ref{fig:P-energy-sum}), witch follows the trend of the number of
occurrences.

<!-- ```{r echo=FALSE, fig.cap="Trend of the yearly excess energy due to CE over irradiance"} -->
<!-- knitr::include_graphics("../images/energy-1.png") -->
<!-- ``` -->

```{r P-energy-sum, echo=FALSE, fig.cap="Trend of the yearly excess energy due to CE over irradiance"}
knitr::include_graphics("../images/P_energy-5.png")
```

```{r P-energy-median, echo=FALSE, fig.cap="Trend of the yearly median over irradiance due to CE over irradiance"}
knitr::include_graphics("../images/P_energy-8.png")
```

\FloatBarrier

## Climatology

Another interesting aspect of the CE cases, is the seasonal cycle. In
Figure\nobreakspace{}\ref{fig:relative-month-occurancies}, we have the box plot
(whisker plot), where the values have been normalized by the highest median value,
that occurs in May.  Although the number of occurrences has a wide spread throughout
the study period, the most active period of CE occurrences is during May and June.
During the Winter (December -- February) the CE cases are about 25% of the maximum.
The rest of the months the occurrences seems to ramp between the maximum and minimum.

```{r relative-month-occurancies, echo=FALSE, fig.cap="Statistics of the number of CE occurancies for each month. The box represents the values of the low 25% percentile to 75% percentile, where the thick horizontal line inside is the mean, the verical lines extend to the macimum and minimum vales, the dots are outlier values, and the rhombus is the mean."}
knitr::include_graphics("../images/clim_CE_month_norm_MAX_median_N-2.png")
```
<!--
```{r echo=FALSE, fig.cap="Distribution of the number of CE cases"}
knitr::include_graphics("../images/climCEmonth-1.png")
```
--->


<!-- ```{r echo=FALSE, fig.cap="Distribution of CE above reference"} -->
<!-- knitr::include_graphics("../images/relative_distributions-2.png") -->
<!-- ``` -->
<!--
```{r echo=FALSE, fig.cap="Distribution of CE above reference"}
knitr::include_graphics("../images/relative_distributions-4.png")
```
-->

The distribution of the CE over irradiance spreads uniformly
Figure\nobreakspace{}\ref{fig:ovir-distribution}. Where there is an inverse relation
between the events frequency and events intensity. This is expected as, the stronger
the CE events become, the more rare are the particular atmospheric and sun conditions
to occur.

```{r ovir-distribution, echo=FALSE, fig.cap="Distribution of CE over irradiance"}
knitr::include_graphics("../images/P-relative-distribution-diff-1.png")
```

<!-- todo stop long tails on hist -->
<!-- hist retative frequency label -->

<!-- Whisky plot relative between months -->
<!-- weight (Nmonth / Nmaxmonth) -->

<!-- whisky plots relative to GLB -->

<!-- set of yearly plots -->

\FloatBarrier

## Groups stats

In order to further study the characteristics of the CE events, we grouped the singe
minute CE events, to continuous CE groups (CEG). Thus, a CEG consists of one or more
successive CE cases, and can have a duration of multiple of minutes.  We have
identified `r ST_G0[, .N]` groups, where the group with the longest duration lasted
`r ST_G0[, max(GLB_diff.N)]` minutes on 
`r strftime(ST_G0[which.max(GLB_diff.N), Date], "%d\\ %B %Y")`.
By examining the frequency distribution of the CEG durations
(Figure\nobreakspace{}\ref{fig:ceg-duration-distribution}), we can conclude that longer durations are getting increasingly rare, with durations above 10 minutes very rare.

```{r ceg-duration-distribution, echo=FALSE, fig.cap="Distribution of CE groups"}
knitr::include_graphics("../images/groups-1.png")
```


... @Zhang2018 ....

```{r echo=FALSE, fig.cap="Relation of mean over irradiance and CE group duration"}
knitr::include_graphics("../images/P-groups-bin2d-1.png")
```



<!-- ```{r echo=FALSE, fig.cap="Relation of mean over irradiance and CE group duration"} -->
<!-- knitr::include_graphics("../images/groups-4.png") -->
<!-- ``` -->

<!-- ```{r echo=FALSE, fig.cap="Relation of maximun over irradiance and CE group duration"} -->
<!-- knitr::include_graphics("../images/groups-8.png") -->
<!-- ``` -->


\FloatBarrier

## Extreme CE above TSI

Another aspect of the CE events are the cases where the irradiance is above the expected irradiance on top of the atmosphere, we have defined this 


```{r echo=FALSE, fig.cap="Distribution of "}
knitr::include_graphics("../images/clim_ECE_month_norm_MAX_median_N-2.png")
```




<!-- ```{r echo=FALSE, fig.cap="Distribution of the number of ECE cases"} -->
<!-- knitr::include_graphics("../images/climECEmonth-1.png") -->
<!-- ``` -->


```{r echo=FALSE, fig.cap="Distribution of ECE above 'clear sky' reference"}
knitr::include_graphics("../images/extremedistributions-2.png")
```


<!-- ```{r echo=FALSE, fig.cap="Distribution of ECE Irradiance above 'TSI'"} -->
<!-- knitr::include_graphics("../images/extremedistributions-4.png") -->
<!-- ``` -->

-   max value ECE
-   seasonal
-   trends
-   duration
-   occurrence
-   SZA

\FloatBarrier

## New plots for discussion




<!-- ### Yearly plots relative to all GHI data. -->
<!-- ```{r echo=FALSE, fig.cap=""} -->
<!-- knitr::include_graphics("../images/rel_energy-1.png") -->
<!-- ``` -->
<!-- ```{r echo=FALSE, fig.cap=""} -->
<!-- knitr::include_graphics("../images/rel_energy-2.png") -->
<!-- ``` -->
<!-- ```{r echo=FALSE, fig.cap=""} -->
<!-- knitr::include_graphics("../images/rel_energy-3.png") -->
<!-- ``` -->


\FloatBarrier


# Discussion and conclusions


Compare to other location stats.
max, ECE, distributions ....


Climatology results




# Appendix {.unnumbered}


# References {.unnumbered}
